<!--app/views/hikes/_form.html.erb-->
<%= form_with(model: @hike, local: true, class: "space-y-6") do |f| %>
    <% if @hike.errors.any? %>
        <div class="rounded-lg bg-red-500/10 border border-red-500/20 p-4 shadow-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="icon icon-exclamation-circle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-300">
                        <%= pluralize(@hike.errors.count, "erreur") %> :
                    </h3>
                    <ul class="mt-2 text-sm text-red-300 list-disc list-inside">
                        <% @hike.errors.full_messages.each do |message| %>
                            <li><%= message %></li>
                        <% end %>
                    </ul>
                </div>
            </div>
        </div>
    <% end %>

    <!-- OpenRunner Reference Section -->
    <div class="bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 p-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
                <%= f.label :openrunner_ref, "Référence OpenRunner", class: "block text-sm font-medium text-slate-300 mb-2" %>
                <div class="flex gap-2">
                    <%= f.text_field :openrunner_ref,
                                     class: "flex-1 rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:openrunner_ref].any? ? 'border-red-500 focus:ring-red-500' : ''}",
                                     id: 'openrunner_ref_input' %>
                    <button type="button"
                            class="inline-flex items-center justify-center rounded-lg bg-gradient-to-r from-blue-600 to-blue-500 px-4 py-3 text-white shadow-lg hover:from-blue-500 hover:to-blue-400 transition-all hover:scale-[1.02] whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"
                            id="fetch_openrunner_data">
                        <i class="icon icon-sync-alt" id="sync_icon"></i>
                    </button>
                </div>
                <p class="mt-2 text-sm text-slate-400 italic">La récupération des informations prend en moyenne 6 secondes.</p>
                <% if @hike.errors[:openrunner_ref].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:openrunner_ref].join(', ') %>
                    </p>
                <% end %>
            </div>
        </div>
    </div>

    <!-- Main Form Fields -->
    <div class="bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 p-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Nom du parcours -->
            <div>
                <%= f.label :trail_name, class: "block text-sm font-medium text-slate-300 mb-2" do %>
                    Nom du parcours <span class="text-red-400">*</span>
                <% end %>
                <%= f.text_field :trail_name,
                                 class: "block w-full rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:trail_name].any? ? 'border-red-500 focus:ring-red-500' : ''}" %>
                <% if @hike.errors[:trail_name].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:trail_name].join(', ') %>
                    </p>
                <% end %>
            </div>

            <!-- Point de départ -->
            <div>
                <%= f.label :starting_point, class: "block text-sm font-medium text-slate-300 mb-2" do %>
                    Point de départ <span class="text-red-400">*</span>
                <% end %>
                <%= f.text_field :starting_point,
                                 class: "block w-full rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:starting_point].any? ? 'border-red-500 focus:ring-red-500' : ''}" %>
                <% if @hike.errors[:starting_point].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:starting_point].join(', ') %>
                    </p>
                <% end %>
            </div>

            <!-- Distance -->
            <div>
                <%= f.label :distance_km, class: "block text-sm font-medium text-slate-300 mb-2" do %>
                    Distance (km) <span class="text-red-400">*</span>
                <% end %>
                <%= f.number_field :distance_km,
                                   class: "block w-full rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:distance_km].any? ? 'border-red-500 focus:ring-red-500' : ''}",
                                   step: "0.01" %>
                <% if @hike.errors[:distance_km].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:distance_km].join(', ') %>
                    </p>
                <% end %>
            </div>

            <!-- Dénivelé + -->
            <div>
                <%= f.label :elevation_gain, class: "block text-sm font-medium text-slate-300 mb-2" do %>
                    Dénivelé + (m) <span class="text-red-400">*</span>
                <% end %>
                <%= f.number_field :elevation_gain,
                                   class: "block w-full rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:elevation_gain].any? ? 'border-red-500 focus:ring-red-500' : ''}" %>
                <% if @hike.errors[:elevation_gain].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:elevation_gain].join(', ') %>
                    </p>
                <% end %>
            </div>

            <!-- Dénivelé - -->
            <div>
                <%= f.label :elevation_loss, "Dénivelé - (m)", class: "block text-sm font-medium text-slate-300 mb-2" %>
                <%= f.number_field :elevation_loss,
                                   class: "block w-full rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:elevation_loss].any? ? 'border-red-500 focus:ring-red-500' : ''}" %>
                <% if @hike.errors[:elevation_loss].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:elevation_loss].join(', ') %>
                    </p>
                <% end %>
            </div>

            <!-- Altitude min -->
            <div>
                <%= f.label :altitude_min, "Altitude min (m)", class: "block text-sm font-medium text-slate-300 mb-2" %>
                <%= f.number_field :altitude_min,
                                   class: "block w-full rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:altitude_min].any? ? 'border-red-500 focus:ring-red-500' : ''}" %>
                <% if @hike.errors[:altitude_min].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:altitude_min].join(', ') %>
                    </p>
                <% end %>
            </div>

            <!-- Altitude max -->
            <div>
                <%= f.label :altitude_max, "Altitude max (m)", class: "block text-sm font-medium text-slate-300 mb-2" %>
                <%= f.number_field :altitude_max,
                                   class: "block w-full rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:altitude_max].any? ? 'border-red-500 focus:ring-red-500' : ''}" %>
                <% if @hike.errors[:altitude_max].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:altitude_max].join(', ') %>
                    </p>
                <% end %>
            </div>

            <!-- Type -->
            <div>
                <%= f.label :day, "Type", class: "block text-sm font-medium text-slate-300 mb-2" %>
                <%= f.select :day,
                             [
                                 ['Sélectionnez un type de repas', ''],
                                 ['Apéro', 'apero'],
                                 ['Petit déjeuner', 'petit_dejeuner'],
                                 ['Déjeuner', 'dejeuner'],
                                 ['Dîner', 'diner'],
                                 ['Pique-nique', 'picnic']
                             ],
                             {},
                             { class: "block w-full rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:meal_type].any? ? 'border-red-500 focus:ring-red-500' : ''}" }
                %>
                <% if @hike.errors[:meal_type].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:meal_type].join(', ') %>
                    </p>
                <% end %>
            </div>

            <!-- Difficulté -->
            <div>
                <%= f.label :difficulty, class: "block text-sm font-medium text-slate-300 mb-2" do %>
                    Difficulté <span class="text-red-400">*</span>
                <% end %>
                <div class="flex items-center gap-4">
                    <%= f.range_field :difficulty,
                                      min: 1,
                                      max: 5,
                                      value: @hike.difficulty,
                                      class: "flex-1 h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500 #{@hike.errors[:difficulty].any? ? 'border-red-500' : ''}",
                                      data: {
                                          controller: "difficulty",
                                          difficulties: {
                                              "1": "Très facile",
                                              "2": "Facile",
                                              "3": "Moyen",
                                              "4": "Difficile",
                                              "5": "Très difficile"
                                          }.to_json
                                      } %>
                    <span class="inline-flex items-center rounded-lg bg-blue-500/20 px-3 py-1 text-sm font-medium text-blue-300 border border-blue-500/30 whitespace-nowrap" data-difficulty-target="display">
                        <%= "#{@hike.difficulty} - #{@hike.difficulty_text}" %>
                    </span>
                </div>
                <% if @hike.errors[:difficulty].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:difficulty].join(', ') %>
                    </p>
                <% end %>
            </div>

            <!-- Coût covoiturage -->
            <div>
                <%= f.label :carpooling_cost, "Coût covoiturage", class: "block text-sm font-medium text-slate-300 mb-2" %>
                <%= f.number_field :carpooling_cost,
                                   step: 0.1,
                                   placeholder: "0.00",
                                   class: "block w-full rounded-lg bg-slate-700 px-4 py-3 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 transition-all #{@hike.errors[:carpooling_cost].any? ? 'border-red-500 focus:ring-red-500' : ''}" %>
                <% if @hike.errors[:carpooling_cost].any? %>
                    <p class="mt-2 text-sm text-red-400">
                        <%= @hike.errors[:carpooling_cost].join(', ') %>
                    </p>
                <% end %>
            </div>
        </div>
    </div>

    <%= f.hidden_field :coordinates, :value => "" %>
    <%= render "hike_paths/map", variable: @hike_path %>

    <!-- Action Buttons -->
    <div class="flex gap-3">
        <% if can?(:update, Hike) %>
            <%= f.submit "Enregistrer", class: "rounded-lg bg-gradient-to-r from-blue-600 to-blue-500 px-6 py-3 text-white shadow-lg hover:from-blue-500 hover:to-blue-400 transition-all hover:scale-[1.02]" %>
        <% end %>
        <%= link_to "Retour", hikes_path, class: "rounded-lg bg-slate-700 px-6 py-3 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all" %>
    </div>
<% end %>

<script>
    document.addEventListener('input', function (e) {
        if (e.target.matches('input[type="range"]')) {
            const difficulties = {
                "1": "Très facile",
                "2": "Facile",
                "3": "Moyen",
                "4": "Difficile",
                "5": "Très difficile"
            };
            if (!e.target.dataset.controller) return;
            const value = e.target.value;
            const display = e.target.closest('div').querySelector('[data-difficulty-target="display"]');
            if (display) {
                display.textContent = `${value} - ${difficulties[value]}`;
            }
        }
    });
</script>

<script type="module">
    import "hikes"
    import "map"

    <% unless @hike_path&.coordinates.blank? %>
    document.addEventListener('DOMContentLoaded', () => {
        const event = new CustomEvent('coordinatesLoaded', {
            detail: <%= @hike_path.coordinates.to_json.html_safe %>
        });
        document.dispatchEvent(event);
    });
    <% end %>
</script>
