<% if @last_hikes.any? %>
    <%
        has_any_permission = can?(:update, Hike) ||
            can?(:destroy, Hike) ||
            can?(:read, HikeHistory)
    %>
    <div class="overflow-x-auto bg-slate-800 rounded-2xl shadow-2xl border border-slate-700">
        <table class="min-w-full divide-y divide-slate-700">
                <thead class="bg-slate-700/50">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Randonnée</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Point de départ</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Distance (km)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">D+ (m)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">D- (m)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Alt min (m)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Alt max (m)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Difficulté</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Dernière date</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Dernier guide</th>
                        <% if has_any_permission %>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Actions</th>
                        <% end %>
                    </tr>
                </thead>
                <tbody class="bg-slate-800 divide-y divide-slate-700">
                    <% @last_hikes.each do |hike| %>
                        <tr class="hover:bg-slate-700/30 transition-colors">
                            <td class="px-4 py-3 text-sm text-white"><%= hike.trail_name %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.starting_point %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.distance_km %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.elevation_gain %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.elevation_loss %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.altitude_min %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.altitude_max %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.difficulty_text %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.last_hiking_date&.strftime("%d/%m/%Y") %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike['guide_name'] %></td>
                            <% if has_any_permission %>
                                <td class="px-4 py-3 text-sm whitespace-nowrap">
                                    <div class="flex gap-2">
                                        <%= render partial: "roadmap", locals: { hike: hike } %>

                                        <%= link_to_if_authorized hike_histories_path(hike_id: hike.id),
                                                    class: "p-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all",
                                                    title: "Voir l'historique",
                                                    action: :read,
                                                    resource: HikeHistory do %>
                                            <i class="icon icon-history"></i>
                                        <% end %>

                                        <%= link_to_if_authorized edit_hike_path(hike),
                                                    class: "p-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all",
                                                    title: "Editer",
                                                    action: :update,
                                                    resource: Hike do %>
                                            <i class="icon icon-pen"></i>
                                        <% end %>

                                        <% if can?(:update, Hike) %>
                                            <% if hike.updating? %>
                                                <button class="p-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600" disabled>
                                                    <i class="icon icon-sync-alt animate-spin"></i>
                                                </button>
                                            <% elsif hike.openrunner_ref.blank? or hike.openrunner_ref == 0 or hike.openrunner_ref == "0" %>
                                                <button class="p-2 rounded-lg bg-slate-700 text-slate-500 border border-slate-600" disabled title="Pas de référence OpenRunner">
                                                    <i class="icon icon-ban text-red-400"></i>
                                                </button>
                                            <% else %>
                                                <%= button_to refresh_from_openrunner_hike_path(hike, redirect_path: stats_dashboard_path),
                                                              class: "p-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all",
                                                              title: "Dernière mise à jour: #{hike.last_update_attempt&.strftime('%d/%m/%Y %H:%M') || 'Jamais'}",
                                                              data: { turbo: false },
                                                              params: { search: params[:search] } do %>
                                                    <i class="icon icon-sync-alt"></i>
                                                <% end %>
                                            <% end %>
                                        <% end %>
                                    </div>
                                </td>
                            <% end %>
                        </tr>
                    <% end %>
                </tbody>
        </table>
    </div>
<% elsif params[:trail_name].present? || params[:starting_point].present? %>
    <div class="rounded-lg bg-blue-500/10 border border-blue-500/20 p-4 text-blue-300">
        Aucun résultat trouvé pour votre recherche
    </div>
<% end %>
