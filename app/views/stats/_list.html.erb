<% if @last_hikes.any? %>
    <%
        has_any_permission = can?(:update, Hike) ||
            can?(:destroy, Hike) ||
            can?(:read, HikeHistory)
    %>

    <!-- Version desktop (tableau) -->
    <div class="hidden md:block overflow-x-auto bg-slate-800 rounded-2xl shadow-2xl border border-slate-700">
        <table class="min-w-full divide-y divide-slate-700">
                <thead class="bg-slate-700/50">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Randonnée</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Point de départ</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Distance (km)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">D+ (m)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">D- (m)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Alt min (m)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Alt max (m)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Difficulté</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Dernière date</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Dernier guide</th>
                        <% if has_any_permission %>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Actions</th>
                        <% end %>
                    </tr>
                </thead>
                <tbody class="bg-slate-800 divide-y divide-slate-700">
                    <% @last_hikes.each do |hike| %>
                        <tr class="hover:bg-slate-700/30 transition-colors">
                            <td class="px-4 py-3 text-sm text-white"><%= hike.trail_name %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.starting_point %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.distance_km %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.elevation_gain %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.elevation_loss %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.altitude_min %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.altitude_max %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.difficulty_text %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike.last_hiking_date&.strftime("%d/%m/%Y") %></td>
                            <td class="px-4 py-3 text-sm text-slate-300"><%= hike['guide_name'] %></td>
                            <% if has_any_permission %>
                                <td class="px-4 py-3 text-sm whitespace-nowrap">
                                    <div class="flex gap-2">
                                        <%= render partial: "roadmap", locals: { hike: hike } %>

                                        <%= link_to_if_authorized hike_histories_path(hike_id: hike.id),
                                                    class: "p-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all",
                                                    title: "Voir l'historique",
                                                    action: :read,
                                                    resource: HikeHistory do %>
                                            <i class="icon icon-history"></i>
                                        <% end %>

                                        <%= link_to_if_authorized edit_hike_path(hike),
                                                    class: "p-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all",
                                                    title: "Editer",
                                                    action: :update,
                                                    resource: Hike do %>
                                            <i class="icon icon-pen"></i>
                                        <% end %>

                                        <% if can?(:update, Hike) %>
                                            <% if hike.updating? %>
                                                <button class="p-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600"
                                                        data-hike-updating="true"
                                                        data-hike-id="<%= hike.id %>"
                                                        disabled>
                                                    <i class="icon icon-sync-alt animate-spin"></i>
                                                </button>
                                            <% elsif hike.openrunner_ref.blank? or hike.openrunner_ref == 0 or hike.openrunner_ref == "0" %>
                                                <button class="p-2 rounded-lg bg-slate-700 text-slate-500 border border-slate-600" disabled title="Pas de référence OpenRunner">
                                                    <i class="icon icon-ban text-red-400"></i>
                                                </button>
                                            <% else %>
                                                <%= button_to refresh_from_openrunner_hike_path(hike, redirect_path: stats_dashboard_path),
                                                              class: "p-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all",
                                                              title: "Dernière mise à jour: #{hike.last_update_attempt&.strftime('%d/%m/%Y %H:%M') || 'Jamais'}",
                                                              data: { turbo: false },
                                                              params: { search: params[:search] } do %>
                                                    <i class="icon icon-sync-alt"></i>
                                                <% end %>
                                            <% end %>
                                        <% end %>
                                    </div>
                                </td>
                            <% end %>
                        </tr>
                    <% end %>
                </tbody>
        </table>
    </div>

    <!-- Version mobile (cardes) -->
    <div class="md:hidden space-y-4">
        <% @last_hikes.each do |hike| %>
            <div class="bg-slate-800 rounded-2xl shadow-2xl p-4 border border-slate-700">
                <!-- Header -->
                <div class="mb-3">
                    <h3 class="text-lg font-bold text-white mb-1"><%= hike.trail_name %></h3>
                    <div class="flex items-center text-slate-400 text-sm">
                        <i class="icon icon-map-marker-alt mr-1"></i>
                        <%= hike.starting_point || "Non défini" %>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-slate-700/50 rounded-lg p-2">
                        <div class="text-xs text-slate-400">Distance</div>
                        <div class="text-white font-medium"><%= hike.distance_km || "-" %> km</div>
                    </div>
                    <div class="bg-slate-700/50 rounded-lg p-2">
                        <div class="text-xs text-slate-400">D+ / D-</div>
                        <div class="text-white font-medium"><%= hike.elevation_gain || "-" %> / <%= hike.elevation_loss || "-" %> m</div>
                    </div>
                    <div class="bg-slate-700/50 rounded-lg p-2">
                        <div class="text-xs text-slate-400">Altitude</div>
                        <div class="text-white font-medium"><%= hike.altitude_min || "-" %> - <%= hike.altitude_max || "-" %> m</div>
                    </div>
                    <div class="bg-slate-700/50 rounded-lg p-2">
                        <div class="text-xs text-slate-400">Difficulté</div>
                        <div class="text-white font-medium"><%= hike.difficulty_text %></div>
                    </div>
                </div>

                <!-- Dernière rando -->
                <div class="bg-slate-700/30 rounded-lg p-2 mb-3 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="text-slate-400">
                            <i class="far fa-calendar mr-1"></i>
                            <%= hike.last_hiking_date&.strftime("%d/%m/%Y") || "Jamais" %>
                        </span>
                        <span class="text-slate-300"><%= hike['guide_name'] || "-" %></span>
                    </div>
                </div>

                <!-- Actions -->
                <% if has_any_permission %>
                    <div class="flex gap-2 flex-wrap">
                        <%= render partial: "roadmap", locals: {
                          hike: hike,
                          button_class: "flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 transition-all text-sm",
                          disabled_class: "flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg bg-slate-700 text-red-400 cursor-not-allowed text-sm"
                        } %>

                        <%= link_to_if_authorized hike_histories_path(hike_id: hike.id),
                                                  action: :read,
                                                  resource: HikeHistory,
                                                  class: "flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 transition-all text-sm",
                                                  title: "Historique" do %>
                            <i class="icon icon-history mr-1"></i> Historique
                        <% end %>

                        <%= link_to_if_authorized edit_hike_path(hike),
                                                  action: :update,
                                                  resource: Hike,
                                                  class: "flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 transition-all text-sm",
                                                  title: "Éditer" do %>
                            <i class="icon icon-pen mr-1"></i> Éditer
                        <% end %>

                        <% if can?(:update, Hike) %>
                            <% if hike.updating? %>
                                <button class="flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg bg-slate-700 text-slate-400 cursor-not-allowed text-sm"
                                        disabled
                                        data-hike-updating="true"
                                        data-hike-id="<%= hike.id %>">
                                    <i class="icon icon-sync-alt spin mr-1"></i> Mise à jour...
                                </button>
                            <% elsif hike.openrunner_ref.blank? || hike.openrunner_ref == 0 || hike.openrunner_ref == "0" %>
                                <button class="flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg bg-slate-700 text-red-400 cursor-not-allowed text-sm"
                                        disabled
                                        title="Pas de référence OpenRunner">
                                    <i class="icon icon-ban mr-1"></i> N/A
                                </button>
                            <% else %>
                                <%= button_to refresh_from_openrunner_hike_path(hike, redirect_path: stats_dashboard_path),
                                              class: "flex-1 inline-flex items-center justify-center px-3 py-2 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 transition-all text-sm",
                                              title: "Dernière mise à jour: #{hike.last_update_attempt&.strftime('%d/%m/%Y %H:%M') || 'Jamais'}",
                                              data: { turbo: false },
                                              params: { search: params[:search] } do %>
                                    <i class="icon icon-sync-alt mr-1"></i> MAJ
                                <% end %>
                            <% end %>
                        <% end %>
                    </div>
                <% end %>
            </div>
        <% end %>
    </div>
<% elsif params[:trail_name].present? || params[:starting_point].present? %>
    <div class="rounded-lg bg-blue-500/10 border border-blue-500/20 p-4 text-blue-300">
        Aucun résultat trouvé pour votre recherche
    </div>
<% end %>
